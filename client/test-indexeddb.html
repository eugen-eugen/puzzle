<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IndexedDB Test</title>
</head>
<body>
    <h2>IndexedDB Storage Test</h2>
    <input type="file" id="fileInput" accept="image/*">
    <button onclick="testStore()">Store Image</button>
    <button onclick="testLoad()">Load Image</button>
    <button onclick="testList()">List Images</button>
    <button onclick="testClear()">Clear All</button>
    
    <div id="status"></div>
    <div id="imageContainer"></div>

    <script type="module">
        import {
            isIndexedDBSupported,
            storeImageInDB,
            loadImageFromDB,
            listStoredImages,
            clearAllImages,
            getStorageStats
        } from './js/persistence/indexed-db-storage.js';

        let currentImageId = null;

        window.testStore = async function() {
            const fileInput = document.getElementById('fileInput');
            const status = document.getElementById('status');
            
            if (!fileInput.files[0]) {
                status.textContent = 'Please select a file first';
                return;
            }

            try {
                status.textContent = 'Storing image...';
                const result = await storeImageInDB(fileInput.files[0]);
                currentImageId = result.imageId;
                status.textContent = `Image stored successfully! ID: ${result.imageId}`;
                console.log('Stored image:', result);
            } catch (error) {
                status.textContent = `Error storing image: ${error.message}`;
                console.error('Store error:', error);
            }
        };

        window.testLoad = async function() {
            const status = document.getElementById('status');
            const container = document.getElementById('imageContainer');
            
            if (!currentImageId) {
                status.textContent = 'No image ID available. Store an image first.';
                return;
            }

            try {
                status.textContent = 'Loading image...';
                const imageData = await loadImageFromDB(currentImageId);
                
                const img = document.createElement('img');
                const url = URL.createObjectURL(imageData.blob);
                img.src = url;
                img.style.maxWidth = '300px';
                img.onload = () => URL.revokeObjectURL(url);
                
                container.innerHTML = '';
                container.appendChild(img);
                status.textContent = `Image loaded successfully! Size: ${imageData.size} bytes`;
                console.log('Loaded image:', imageData);
            } catch (error) {
                status.textContent = `Error loading image: ${error.message}`;
                console.error('Load error:', error);
            }
        };

        window.testList = async function() {
            const status = document.getElementById('status');
            
            try {
                const images = await listStoredImages();
                const stats = await getStorageStats();
                status.innerHTML = `
                    <strong>Stored Images:</strong><br>
                    Count: ${stats.imageCount}<br>
                    Total Size: ${stats.formattedSize}<br>
                    <pre>${JSON.stringify(images, null, 2)}</pre>
                `;
                console.log('Images:', images);
            } catch (error) {
                status.textContent = `Error listing images: ${error.message}`;
                console.error('List error:', error);
            }
        };

        window.testClear = async function() {
            const status = document.getElementById('status');
            
            try {
                await clearAllImages();
                currentImageId = null;
                status.textContent = 'All images cleared successfully';
                document.getElementById('imageContainer').innerHTML = '';
            } catch (error) {
                status.textContent = `Error clearing images: ${error.message}`;
                console.error('Clear error:', error);
            }
        };

        // Initial check
        document.getElementById('status').textContent = 
            `IndexedDB Support: ${isIndexedDBSupported() ? 'Yes' : 'No'}`;
    </script>
</body>
</html>